# Arka – Pallet Parsing & Classification Spec (Movement List / UTC Upload)

## 0. Goal

Given a **sanitized movement list** (like the PACAF “Movement List” PDF/CSV), the system must:

1. Parse each row into a clean cargo record.
2. Decide whether the item is:
   - `PALLETIZED` (i.e., built up on a 463L pallet),
   - `ROLLING_STOCK` (vehicles, trailers, loaders, etc.),
   - `LOOSE_CARGO` (odd‑shape non‑pallet cargo, if needed),
   - `PAX` (personnel line items).
3. Assign or generate **pallet identifiers** that incorporate the **Lead TCN**.
4. Provide structured validation errors and warnings.

This spec covers only the **parsing + classification + naming** layer. Downstream placement (aircraft, CoB, 3D) uses the output of this stage.

---

## 1. Input Format & Fields

### 1.1 Expected Columns (per row)

For each cargo record, expect the following columns (case‑insensitive, extra columns allowed):

- `Description` (string)
- `Length` (inches, numeric)
- `Width` (inches, numeric)
- `Height` (inches, numeric)
- `Weight` (pounds, numeric)
- `Lead TCN` (string, may be blank)
- `PAX` (integer, may be blank)

### 1.2 Parsing Rules

- Trim whitespace from all string fields.
- Convert `Length`, `Width`, `Height`, `Weight`, `PAX` to numbers.
  - If conversion fails → issue `ERROR_INVALID_NUMBER` and mark row invalid.
- Allow empty `PAX`; treat `null` or empty as “not a pax record”.

### 1.3 Multiple Tables / Repeated Headers

If the source is converted from PDF and contains repeated header lines:

- Treat any line where **all header names match** (`Description`, `Length`, `Width`, `Height`, `Weight`, `Lead TCN`, `PAX`) as a **header row**, not data.
- Restart parsing after each header row.
- Merge all data rows into a single list after parsing.

---

## 2. High‑Level Classification Flow

For each **valid** row (after numeric parsing):

1. If `PAX` has a positive integer value → classify as `PAX_RECORD`.
2. Else:
   - Run **pallet footprint inference** (Section 3).
   - If positive → classify as `PALLETIZED`.
   - Else:
     - Run **rolling stock inference** (Section 4).
     - If positive → classify as `ROLLING_STOCK`.
     - Else → classify as `LOOSE_CARGO`.

Each row’s output must include:

```ts
type CargoType = "PALLETIZED" | "ROLLING_STOCK" | "LOOSE_CARGO" | "PAX_RECORD";

interface ParsedCargoItem {
  rawRowIndex: number;
  description: string;
  length_in: number;
  width_in: number;
  height_in: number;
  weight_lb: number;
  lead_tcn: string | null;
  pax_count: number | null;
  cargo_type: CargoType;
  pallet_footprint: "463L" | "NONE";
  inferred_pallet_count: number; // e.g. 1 for most palletized items
  classification_reasons: string[]; // human-readable explanation
  validation_errors: ValidationIssue[];
  validation_warnings: ValidationIssue[];
}
3. Palletized Cargo Inference (463L)
3.1 Core Dimensional Rule
A standard 463L pallet has a footprint of 88" × 108" (length × width).
We infer palletization primarily from this footprint.

Rule PALLET_DIM_MATCH:

pseudo
Copy code
is_463L_footprint =
  (Length == 88 && Width == 108) ||
  (Length == 108 && Width == 88)
If is_463L_footprint is true AND Weight <= 10000:

cargo_type = PALLETIZED

pallet_footprint = "463L"

inferred_pallet_count = 1

Add classification_reasons += ["DIM_MATCH_463L"]

Note: 10,000 lb is a common working upper bound for palletized loads; adjust if a better spec is available.

3.2 Text‑Based Hints (Secondary)
If dims are nearly pallet size but not exact, use description as a hint.

Heuristic TEXT_HINTS:

If description (upper‑cased) contains any of:

"PALLET"

"DSP"

"SUPPLIES"

"SE AMU"

"AMU"

"OPS"

"AFE"

"BAG PALLET"

"WEAPONS" (often palletized support equipment)

AND:

Length is between 80–96 inches AND width between 100–116 inches,

then:

cargo_type = PALLETIZED

pallet_footprint = "463L"

Add classification_reasons += ["TEXT_HINT_PALLET_LIKE"]

Flag warning: WARNING_APPROX_DIM_MATCH_463L (for manual review).

3.3 Height Validation
For any item classified as PALLETIZED:

If Height <= 96 → ok (standard interior limit for most positions).

Else:

Keep cargo_type = PALLETIZED but add warning WARNING_OVERHEIGHT_PALLET.

Downstream placement logic must enforce aircraft‑specific height limits.

4. Rolling Stock & Loose Cargo Inference
If not classified as PALLETIZED and PAX is null:

4.1 Rolling Stock Dimensions & Descriptions
Treat an item as ROLLING_STOCK if any of the following are true:

Description contains vehicle/rolling cues (uppercase search):

"TRACTOR", "TRK", "TRUCK", "TRAILER", "TOW", "TOWBAR",
"LOADER", "MHU", "VEH", "FORKLIFT", "RIG", "DOLLY"

Length is significantly greater than width (e.g. length >= 1.5 * width) AND

length >= 120 OR width >= 90

Weight ≥ some “vehicle‑like” threshold, e.g. weight >= 3000 lb AND description not obviously small equipment.

If any rule matches:

cargo_type = ROLLING_STOCK

pallet_footprint = "NONE"

inferred_pallet_count = 0

classification_reasons += ["ROLLING_STOCK_DIM_OR_TEXT_MATCH"]

4.2 Loose Cargo (Fallback)
If not PALLETIZED, not PAX, and not ROLLING_STOCK:

cargo_type = LOOSE_CARGO

pallet_footprint = "NONE"

inferred_pallet_count = 0

classification_reasons += ["DEFAULT_LOOSE_CARGO"]

Downstream logic may palletize or containerize these based on additional rules.

5. PAX Records
If PAX column has > 0 and Weight is 0 or empty:

cargo_type = PAX_RECORD

classification_reasons += ["PAX_COUNT_PRESENT"]

If PAX > 0 and Weight > 0:

Keep cargo_type = PAX_RECORD

Add warning: WARNING_PAX_WITH_WEIGHT (may represent baggage pallet vs pax manifest).

6. Lead TCN–Based Naming & IDs
Each cargo record must generate stable IDs for tracking in the UI and exports.

6.1 Base Cargo ID
pseudo
Copy code
base_id = if (lead_tcn not empty)
            then sanitize(lead_tcn)
            else "ITEM_" + zero_padded(rawRowIndex)
sanitize():

Uppercase,

Remove spaces,

Replace non‑alphanumeric characters with _.

6.2 Pallet ID (for PALLETIZED cargo)
For any cargo_type = PALLETIZED:

pseudo
Copy code
pallet_index_within_tcn = sequential index per (lead_tcn, PALLETIZED)

pallet_id =
  if lead_tcn not empty:
      sanitize(lead_tcn) + "_P" + zero_padded(pallet_index_within_tcn)
  else:
      "P-" + zero_padded(global_pallet_counter)
Store:

ts
Copy code
pallet_id: string | null; // null for non-palletized
pallet_sequence_index: number | null;
6.3 Rolling Stock ID
For ROLLING_STOCK items:

pseudo
Copy code
rolling_id =
  if lead_tcn not empty:
      sanitize(lead_tcn) + "_V1"
  else:
      "VEH-" + zero_padded(vehicle_counter)
(If multiple rows share same Lead TCN and are rolling stock, increment _V1, _V2, etc.)

7. Validation & Warnings
Each row can accumulate validation_errors and validation_warnings objects:

ts
Copy code
interface ValidationIssue {
  code: string;      // MACHINE READABLE: e.g. "ERROR_INVALID_DIMENSIONS"
  message: string;   // HUMAN READABLE: "Height must be > 0"
  field?: string;    // optional: which column
}
7.1 Required Error Conditions
Length <= 0, Width <= 0, Height <= 0, or Weight <= 0:

ERROR_INVALID_DIMENSIONS or ERROR_INVALID_WEIGHT.

Non‑numeric dimension or weight:

ERROR_INVALID_NUMBER.

Missing Description:

ERROR_MISSING_DESCRIPTION.

Any ERROR marks the row as invalid for planning until corrected.

7.2 Common Warnings
WARNING_APPROX_DIM_MATCH_463L — dims close but not exact pallet.

WARNING_OVERHEIGHT_PALLET — palletized item taller than typical limit.

WARNING_PAX_WITH_WEIGHT — ambiguous pax/cargo record.

WARNING_NO_LEAD_TCN — no TCN present; ID is synthetic.

8. Output Aggregations
After parsing and classification:

Provide totals by cargo_type:

total_palletized_weight, total_pallet_count

total_rolling_stock_weight, rolling_stock_count

total_pax, etc.

Provide a list of all pallet_ids and associated Lead TCNs for later:

ICODES export.

Handsontable spreadsheet view.

Aircraft load planner.

9. Implementation Checklist for Builder
Implement parser for movement CSV/PDF‑extracted CSV according to Section 1.

Implement classification logic for:

PALLETIZED (Section 3),

ROLLING_STOCK & LOOSE_CARGO (Section 4),

PAX (Section 5).

Implement Lead TCN‑based naming (Section 6).

Implement validation & warnings (Section 7).

Expose parsed & classified data as a typed array (ParsedCargoItem[]) to:

ICODES export module,

Load planner,

Handsontable spreadsheet UI.

Add unit tests:

At least one example row for each classification path and each major warning/error code.